#################################################################################################
#
# New BlackPill board - stm32f411 + ssd1306(spi) + bme280(i2c with DMA) + qmc5883l(i2c with DMA)
#
#################################################################################################


## Состав рабочего оборудования:

```
* stm32f411 (BlackPill board) - плата микроконтроллера
* ssd1306 - OLED дисплей 0.96" 128x64 (интерфейы SPI)
* bme280 - датчик атмосферного давления, температуры и влажности воздуха(интерфейс I2C с DMA).
* qmc5883L - магнитометер - электронный компас (интерфейс I2C c DMA)
```


# Средства разработки:

```
* STM32CubeMX - графический пакет для создание проектов (на языке Си) под микроконтроллеры семейства STM32
  (https://www.st.com/en/development-tools/stm32cubemx.html).
* System Workbench for STM32 - IDE среда разработки ПО для микроконтроллеров семейства STM32
  (https://www.st.com/en/development-tools/sw4stm32.html).
* ST-LINK V2 - usb отладчик для микроконтроллеров семейства STM8/STM32.
* Saleae USB Logic 8ch - логический анализатор сигналов, 8 каналов , макс. частота дискретизации 24МГц
  (https://www.saleae.com/ru/downloads/)
```


# Функционал:

* ПО построено по модели bare metal (без использования ОС) с использованием самостоятельного буфера событий,
  построенного по принципу fifo. События обслуживаются в основном цикле программы. Формируются события в callBack-функциях
  по завершении прерываний от используемых модулей микроконтроллера.
* Устройство инициализирует некоторые интерфейсы микроконтроллера :
  - ADC1 : аналогово-цифровой преобразователь (измеряет напряжение питания устройства).
  - GPIO : подключены два сетодиода : PB5 - секундный тик, PB8 - индикатор ошибки на устройстве; user_key : пользовательская кнопка.
  - I2C1 : режим мастера с частотой 400Кгц (шина ослуживает bme280, qmc5883l).
  - USART1 : параметры порта 115200 8N1 - порт для логов и передачи AT команд утсройству, если подключен комп.
  - TIM2 : таймер-счетчик временных интервалов в 1 мс., реализован в callback-функции.
  - RTC : часы реального времени, могут быть установлены с помощью команды epoch=XXXXXXXXXX:Y
  - SPI4 : обслуживает OLED SSD1306.
* Прием данных по последовательному порту (USART1) выполняется в callback-функции обработчика прерывания.
* Каждые 250 мс считываются данные с датчиков bme280 и qmc5883l, выполняется пересчет атмосферного
  давления в мм ртутного столба и температуры в градусы Цельсия и влажномть в проценты, полученные данные выдаются
  в USART1, например :

```
12.12 16:50:35 | tik=5001 fifo:1/7 | Vcc=3.300V | BME280: ready=1 mmHg=764.28 degC=24.14 %rH=43.60 | QMC5883L: ready=1 azimut=317
12.12 16:50:40 | tik=10001 fifo:1/7 | Vcc=3.300V | BME280: ready=1 mmHg=764.35 degC=24.14 %rH=43.46 | QMC5883L: ready=1 azimut=317
12.12 16:50:45 | tik=15001 fifo:1/7 | Vcc=3.300V | BME280: ready=1 mmHg=764.29 degC=24.14 %rH=43.90 | QMC5883L: ready=1 azimut=317
```

  Часть этих данные (дата и время, код ошибки устройства, напряжение питания, атмосферное давление,
температура и влажность воздуха, азимут) отображаются на дисплей ssd1306.

* Через usart1 можно отправлять команды на устройство, например :

```
epoch=1608307455:2
    установить текущее время и временную зону
 Unix epoch time - 1608307455
 Time zone - 2
```

```
rst
    рестарт устройства
```


* Функционал проекта в процессе пополнения.

